<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Control Panel - Vote Manipulation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #161b22;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            border: 1px solid #30363d;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 20px;
            color: #58a6ff;
            text-align: center;
            background: linear-gradient(135deg, #58a6ff, #f78166);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .status-panel {
            padding: 15px;
            background: #0d1117;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #30363d;
        }

        .status-panel h2 {
            font-size: 18px;
            margin-bottom: 10px;
            color: #c9d1d9;
        }

        #wsStatus {
            display: flex;
            align-items: center;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .disconnected {
            background-color: #f85149;
        }

        .connecting {
            background-color: #ffa657;
        }

        .connected {
            background-color: #3fb950;
        }

        .control-panel {
            padding: 15px;
            background: #0d1117;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #30363d;
        }

        .control-panel h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #c9d1d9;
        }

        .vote-controls {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .extension-card {
            background: #21262d;
            border-radius: 6px;
            padding: 15px;
            border: 1px solid #30363d;
        }

        .extension-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 10px;
            color: #58a6ff;
        }

        .vote-input {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        input[type="number"] {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 4px;
            padding: 8px 10px;
            color: #c9d1d9;
            font-size: 14px;
            width: 80px;
        }

        .control-buttons {
            display: flex;
            gap: 10px;
        }

        button {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            background: #238636;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        button:hover {
            background: #2ea043;
        }

        button.set-votes {
            background: #1f6feb;
        }

        button.set-votes:hover {
            background: #388bfd;
        }

        .log-panel {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 15px;
        }

        .log-panel h2 {
            font-size: 18px;
            margin-bottom: 10px;
            color: #c9d1d9;
        }

        #logOutput {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            height: 200px;
            overflow-y: auto;
            color: #8b949e;
            margin-top: 10px;
        }

        .log-entry {
            margin-bottom: 5px;
            line-height: 1.4;
        }

        .log-time {
            color: #58a6ff;
        }

        .log-type {
            font-weight: bold;
        }

        .log-type.info {
            color: #58a6ff;
        }

        .log-type.success {
            color: #3fb950;
        }

        .log-type.error {
            color: #f85149;
        }

        .log-content {
            margin-left: 5px;
        }

        .stats-panel {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .stat-card {
            flex: 1;
            background: #21262d;
            border-radius: 6px;
            padding: 15px;
            border: 1px solid #30363d;
            min-width: 200px;
        }

        .stat-title {
            font-size: 14px;
            color: #8b949e;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #58a6ff;
            margin-bottom: 10px;
        }

        /* ç§»é™¤ç·¨è¼¯ç›¸é—œæ¨£å¼ */

        /* ä¿®æ”¹çµ±è¨ˆæ•¸æ“šå½ˆçª—æ¨£å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 10px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 20px;
            color: #58a6ff;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            color: #c9d1d9;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 4px;
            padding: 10px;
            color: #c9d1d9;
            font-size: 14px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #58a6ff;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .modal-button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-button.cancel {
            background: rgba(139, 148, 158, 0.2);
            color: #8b949e;
            border: 1px solid #30363d;
        }

        .modal-button.confirm {
            background: #238636;
            color: white;
        }

        .modal-button:hover {
            transform: translateY(-2px);
        }

        /* ä¿®æ”¹è¨˜éŒ„é¢æ¿æ¨£å¼ */
        .history-panel {
            margin-bottom: 20px;
        }

        .history-list {
            max-height: 300px;
            overflow-y: auto;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 10px;
        }

        .history-item {
            padding: 8px 12px;
            margin-bottom: 8px;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 4px;
            font-size: 13px;
        }

        .history-item:last-child {
            margin-bottom: 0;
        }

        .history-time {
            color: #8b949e;
            font-size: 11px;
            margin-bottom: 3px;
        }

        .history-action {
            color: #58a6ff;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .history-details {
            color: #c9d1d9;
            font-size: 12px;
            line-height: 1.4;
        }

        .history-empty {
            text-align: center;
            color: #8b949e;
            font-style: italic;
            padding: 20px;
        }

        @media (max-width: 768px) {
            .vote-controls {
                grid-template-columns: 1fr;
            }
            
            .stats-panel {
                flex-direction: column;
            }
        }
    </style>
    
    <!-- è¼‰å…¥é…ç½®æª”æ¡ˆ -->
    <script src="../user-interface/config.js"></script>
</head>
<body>
    <div class="container">
        <h1>æŠ•ç¥¨æ§åˆ¶é¢æ¿</h1>
        
        <div class="status-panel">
            <h2>é€£ç·šç‹€æ…‹</h2>
            <div id="wsStatus">
                <div class="status-indicator disconnected"></div>
                <span>æœªé€£æ¥</span>
            </div>
        </div>
        
        <div class="control-panel">
            <h2>æ´»å‹•çµ±è¨ˆæ•¸æ“š</h2>
            <div class="stats-panel">
                <div class="stat-card">
                    <div class="stat-title">ç¸½ç™¼å°„ç«ç®­æ¬¡æ•¸</div>
                    <div class="stat-value" id="totalRockets">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">ç•¶å‰åœ¨ç·šäººæ•¸</div>
                    <div class="stat-value" id="activeParticipants">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">æœ€é«˜åŒæ™‚åœ¨ç·š</div>
                    <div class="stat-value" id="maxActiveParticipants">0</div>
                    <div style="font-size: 11px; color: #8b949e; margin-top: 5px;" id="maxActiveTime">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">æ­·å²ç¸½åƒèˆ‡äººæ•¸</div>
                    <div class="stat-value" id="totalParticipants">0</div>
                </div>
            </div>
            <div style="margin-top: 15px; text-align: center;">
                <button onclick="requestStatistics()" style="background: #1f6feb; margin-right: 10px;">åˆ·æ–°çµ±è¨ˆæ•¸æ“š</button>
                <button onclick="syncStatistics()" style="background: #238636; margin-right: 10px;">åŒæ­¥æ•¸æ“š</button>
                <button onclick="showModifyStatsModal()" style="background: #f78166;">ä¿®æ”¹çµ±è¨ˆæ•¸æ“š</button>
            </div>
                        <div style="margin-top: 10px; text-align: center; font-size: 0.85em; color: #8b949e;">
                <p>ã€Œç•¶å‰åœ¨ç·šäººæ•¸ã€è¡¨ç¤ºç›®å‰é€£ç·šåˆ°ç³»çµ±çš„ç”¨æˆ¶æ•¸é‡</p>
                <p>ã€Œæ­·å²ç¸½åƒèˆ‡äººæ•¸ã€è¡¨ç¤ºè‡ªç³»çµ±å•Ÿå‹•ä»¥ä¾†é€£ç·šéçš„ç¸½ç”¨æˆ¶æ•¸</p>
            </div>
        </div>
        
        <div class="control-panel">
            <h2>æ¸¬é©—çµæœç®¡ç†</h2>
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <div style="background: #0d1117; padding: 15px; border-radius: 6px; border: 1px solid #30363d;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="font-weight: 600; color: #c9d1d9;">æ¸¬é©—çµæœç¸½æ•¸ï¼š</span>
                        <span id="quizResultsCount" style="color: #58a6ff; font-weight: bold;">è¼‰å…¥ä¸­...</span>
                    </div>
                    <div style="text-align: center;">
                        <button onclick="refreshQuizResults()" style="background: #1f6feb; margin-right: 10px;">åˆ·æ–°æ•¸æ“š</button>
                        <button onclick="downloadQuizResultsCSV()" style="background: #238636;">ä¸‹è¼‰ CSV</button>
                    </div>
                </div>
                <div style="font-size: 0.85em; color: #8b949e; text-align: center;">
                    <p>ä¸‹è¼‰çš„ CSV æª”æ¡ˆåŒ…å«æ‰€æœ‰æ¸¬é©—ç­”æ¡ˆã€ç”¨æˆ¶è³‡è¨Šã€å®Œæˆæ™‚é–“ç­‰è©³ç´°è³‡æ–™</p>
                </div>
            </div>
        </div>
        
        <div class="control-panel">
            <h2>æŠ•ç¥¨æ§åˆ¶</h2>
            <div class="vote-controls" id="voteControls">
                <!-- æ“´å……å¥—ä»¶æŠ•ç¥¨æ§åˆ¶å¡ç‰‡å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>
        
        <div class="log-panel">
            <h2>æ“ä½œæ—¥èªŒ</h2>
            <div id="logOutput"></div>
        </div>
        
        <div class="control-panel history-panel">
            <h2>ä¿®æ”¹è¨˜éŒ„</h2>
            <div style="margin-bottom: 10px; text-align: right;">
                <button onclick="clearModificationHistory()" style="background: #d73a49; font-size: 12px; padding: 6px 12px;">æ¸…é™¤è¨˜éŒ„</button>
            </div>
            <div class="history-list" id="historyList">
                <div class="history-empty">æš«ç„¡ä¿®æ”¹è¨˜éŒ„</div>
            </div>
        </div>
    </div>

    <!-- ä¿®æ”¹çµ±è¨ˆæ•¸æ“šå½ˆçª— -->
    <div class="modal-overlay" id="modifyStatsModal">
        <div class="modal-content">
            <h2 class="modal-title">ä¿®æ”¹çµ±è¨ˆæ•¸æ“š</h2>
            <div class="form-group">
                <label for="modifyTotalRockets">ç¸½ç™¼å°„ç«ç®­æ¬¡æ•¸ï¼š</label>
                <input type="number" id="modifyTotalRockets" min="0" value="0">
            </div>
            <div class="form-group">
                <label for="modifyActiveParticipants">ç•¶å‰åœ¨ç·šäººæ•¸ï¼š</label>
                <input type="number" id="modifyActiveParticipants" min="0" value="0" readonly style="background: #21262d; color: #8b949e; cursor: not-allowed;">
                <small style="color: #8b949e; font-size: 12px;">æ­¤æ•¸å€¼ç”±ç³»çµ±è‡ªå‹•ç®¡ç†ï¼Œä¸å¯æ‰‹å‹•ä¿®æ”¹</small>
            </div>
            <div class="form-group">
                <label for="modifyTotalParticipants">æ­·å²ç¸½åƒèˆ‡äººæ•¸ï¼š</label>
                <input type="number" id="modifyTotalParticipants" min="0" value="0">
            </div>
            <div class="modal-buttons">
                <button class="modal-button cancel" onclick="closeModifyStatsModal()">å–æ¶ˆ</button>
                <button class="modal-button" onclick="resetActiveParticipants()" style="background: #6f42c1;">é‡ç½®åœ¨ç·šäººæ•¸</button>
                <button class="modal-button confirm" onclick="confirmModifyStats()">ç¢ºå®šä¿®æ”¹</button>
            </div>
        </div>
    </div>

    <script>
        // è¨­å®š WebSocket é€£ç·š
        let socket;
        // å‹•æ…‹é¸æ“‡ WebSocket URL
        const isLocalhost = window.location.hostname === 'localhost' || 
                           window.location.hostname === '127.0.0.1' ||
                           window.location.hostname === '';
        let wsUrl = isLocalhost ? 
            `ws://${window.location.host}/ws` : 
            'wss://ca-dev-backend-qomwbbchmqcjy.purpleflower-f1dc6fb5.eastasia.azurecontainerapps.io/ws';
        let reconnectTimeout;
        
        // èª¿è©¦ä¿¡æ¯
        
        // çµ±è¨ˆæ•¸æ“š
        let statistics = {
            totalRockets: 0,
            totalParticipants: 0,
            activeParticipants: 0,
            maxActiveParticipants: 0,
            maxActiveTime: null
        };
        
        // ç®¡ç†å“¡ä¿®æ”¹ä¿è­·æ¨™è¨˜ (é˜²æ­¢ä¿®æ”¹å¾Œç«‹å³è¢«è¦†è“‹)
        let adminModificationProtection = {
            totalRockets: false,
            totalParticipants: false,
            protectionTimeout: null,
            // è·Ÿè¸ªæ‰‹å‹•ä¿®æ”¹æ™‚çš„åŸºæº–å€¼ï¼Œç”¨æ–¼è¨ˆç®—å¾ŒçºŒå¢é‡
            baselineValues: {
                totalRockets: 0,
                totalParticipants: 0
            }
        };
        
        // ç­‰å¾…å¾Œç«¯ç¢ºèªçš„çµ±è¨ˆä¿®æ”¹
        let pendingStatsModification = null;
        
        // ä¿®æ”¹è¨˜éŒ„é™£åˆ—
        let modificationHistory = [];
        
        // GMT+8 æ™‚é–“è½‰æ›å‡½æ•¸
        function formatTimeGMT8(isoString) {
            const date = new Date(isoString);
            // ç›´æ¥ä½¿ç”¨æœ¬åœ°æ™‚é–“ï¼Œä¸éœ€è¦å†åŠ 8å°æ™‚
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }
        
        // æ·»åŠ ä¿®æ”¹è¨˜éŒ„
        function addModificationRecord(action, details, timestamp = null) {
            const record = {
                action: action,
                details: details,
                timestamp: timestamp || new Date().toISOString()
            };
            
            modificationHistory.unshift(record); // æœ€æ–°è¨˜éŒ„åœ¨æœ€å‰é¢
            
            // é™åˆ¶è¨˜éŒ„æ•¸é‡ï¼Œä¿ç•™æœ€è¿‘50ç­†
            if (modificationHistory.length > 50) {
                modificationHistory = modificationHistory.slice(0, 50);
            }
            
            updateHistoryDisplay();
            
            // åŒæ­¥åˆ°å¾Œç«¯é€²è¡ŒæŒä¹…åŒ–
            syncModificationRecordToBackend(record);
        }
        
        // åŒæ­¥ä¿®æ”¹è¨˜éŒ„åˆ°å¾Œç«¯
        function syncModificationRecordToBackend(record) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                const message = {
                    type: 'add_modification_record',
                    record: record,
                    timestamp: new Date().toISOString()
                };
                socket.send(JSON.stringify(message));
                console.log('å·²åŒæ­¥ä¿®æ”¹è¨˜éŒ„åˆ°å¾Œç«¯:', record);
            }
        }
        
        // æ›´æ–°ä¿®æ”¹è¨˜éŒ„é¡¯ç¤º
        function updateHistoryDisplay() {
            const historyList = document.getElementById('historyList');
            
            if (modificationHistory.length === 0) {
                historyList.innerHTML = '<div class="history-empty">æš«ç„¡ä¿®æ”¹è¨˜éŒ„</div>';
                return;
            }
            
            const historyHTML = modificationHistory.map(record => `
                <div class="history-item">
                    <div class="history-time">${formatTimeGMT8(record.timestamp)}</div>
                    <div class="history-action">${record.action}</div>
                    <div class="history-details">${record.details}</div>
                </div>
            `).join('');
            
            historyList.innerHTML = historyHTML;
        }
        
        // å¾å¾Œç«¯è¼‰å…¥ä¿®æ”¹è¨˜éŒ„
        function loadModificationHistory(historyArray) {
            if (Array.isArray(historyArray)) {
                modificationHistory = historyArray;
                console.log('å·²è¼‰å…¥ä¿®æ”¹è¨˜éŒ„:', modificationHistory.length, 'ç­†');
                updateHistoryDisplay();
            } else {
                console.error('è¼‰å…¥çš„ä¿®æ”¹è¨˜éŒ„æ ¼å¼éŒ¯èª¤:', historyArray);
            }
        }
        
        // æ¸…é™¤ä¿®æ”¹è¨˜éŒ„
        function clearModificationHistory() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ä¿®æ”¹è¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                modificationHistory = [];
                updateHistoryDisplay();
                addLog('info', 'å·²æ¸…é™¤æ‰€æœ‰ä¿®æ”¹è¨˜éŒ„');
                
                // å‘å¾Œç«¯ç™¼é€æ¸…é™¤è¨˜éŒ„çš„è«‹æ±‚
                if (socket && socket.readyState === WebSocket.OPEN) {
                    const message = {
                        type: 'clear_modification_history',
                        timestamp: new Date().toISOString()
                    };
                    socket.send(JSON.stringify(message));
                    addLog('success', 'å·²å‘å¾Œç«¯ç™¼é€æ¸…é™¤è¨˜éŒ„è«‹æ±‚');
                }
            }
        }
        
        // æ“´å……å¥—ä»¶æ•¸æ“š (å°‡å¾å¾Œç«¯ API è¼‰å…¥)
        let extensions = [];
        
        // å¾Œç«¯ API åŸºç¤ URL
        const API_BASE_URL = 'https://ca-dev-backend-qomwbbchmqcjy.purpleflower-f1dc6fb5.eastasia.azurecontainerapps.io/api';
        
        // è¼‰å…¥æ“´å±•æ•¸æ“šå¾å¾Œç«¯ API
        async function loadExtensionsData() {
            try {
                console.log('ğŸ”„ è¼‰å…¥æ“´å±•æ•¸æ“š...');
                const response = await fetch(`${API_BASE_URL}/extensions`);
                if (!response.ok) {
                    throw new Error(`API è«‹æ±‚å¤±æ•—: ${response.status}`);
                }
                const data = await response.json();
                extensions = data.success ? data.data : data;
                console.log('âœ… æ“´å±•æ•¸æ“šè¼‰å…¥æˆåŠŸ:', extensions);
                return extensions;
            } catch (error) {
                console.error('âŒ è¼‰å…¥æ“´å±•æ•¸æ“šå¤±æ•—:', error);
                // ä½¿ç”¨å‚™ç”¨çš„ç¡¬ç·¨ç¢¼æ•¸æ“š
                extensions = [
                    { id: 'vscode-pets', name: 'VSCode Pets', rockets: 0 },
                    { id: 'live-preview', name: 'Live Preview', rockets: 0 },
                    { id: 'github-copilot', name: 'GitHub Copilot', rockets: 0 },
                    { id: 'power-mode', name: 'Power Mode', rockets: 0 },
                    { id: 'code-runner', name: 'Code Runner', rockets: 0 },
                    { id: 'synthwave-theme', name: "Synthwave '84 Theme", rockets: 0 },
                    { id: 'wakatime', name: 'WakaTime', rockets: 0 },
                    { id: 'todo-highlight', name: 'TODO Highlight', rockets: 0 },
                    { id: 'gitlens', name: 'GitLens', rockets: 0 },
                    { id: 'live-share', name: 'Live Share', rockets: 0 },
                    { id: 'azure-tools', name: 'Azure Tools', rockets: 0 },
                    { id: 'azure-ml', name: 'Azure ML', rockets: 0 }
                ];
                addLog('error', 'ä½¿ç”¨å‚™ç”¨æ“´å±•æ•¸æ“š');
                return extensions;
            }
        }
        
        // è¼‰å…¥çµ±è¨ˆæ•¸æ“šå¾å¾Œç«¯ API
        async function loadStatisticsData() {
            try {
                console.log('ğŸ”„ è¼‰å…¥çµ±è¨ˆæ•¸æ“š...');
                const response = await fetch(`${API_BASE_URL}/stats`);
                if (!response.ok) {
                    throw new Error(`API è«‹æ±‚å¤±æ•—: ${response.status}`);
                }
                const data = await response.json();
                const apiStats = data.success ? data.data : data;
                
                // è¨ˆç®—å¯¦éš›çµ±è¨ˆæ•¸æ“š
                const totalRockets = extensions.reduce((sum, ext) => sum + (ext.rockets || 0), 0);
                
                // æ›´æ–°å…¨åŸŸ statistics ç‰©ä»¶
                statistics.totalRockets = totalRockets;
                statistics.totalParticipants = apiStats.totalParticipants || 0;
                statistics.activeParticipants = apiStats.activeParticipants || 0;
                statistics.maxActiveParticipants = apiStats.maxActiveParticipants || 0;
                
                console.log('âœ… çµ±è¨ˆæ•¸æ“šè¼‰å…¥æˆåŠŸ:', statistics);
                return statistics;
            } catch (error) {
                console.error('âŒ è¼‰å…¥çµ±è¨ˆæ•¸æ“šå¤±æ•—:', error);
                addLog('error', 'è¼‰å…¥çµ±è¨ˆæ•¸æ“šå¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼');
                return statistics;
            }
        }
        
        // åˆå§‹åŒ–é é¢
        async function initPage() {
            // å…ˆè¼‰å…¥æ•¸æ“šï¼Œå†å‰µå»ºæ§åˆ¶å…ƒä»¶
            await loadExtensionsData();
            await loadStatisticsData();
            createExtensionCards();
            updateStatisticsDisplay();
            initWebSocket();
        }
        
        // å‰µå»ºæ“´å……å¥—ä»¶æ§åˆ¶å¡ç‰‡
        function createExtensionCards() {
            const voteControls = document.getElementById('voteControls');
            voteControls.innerHTML = '';
            
            extensions.forEach(ext => {
                const card = document.createElement('div');
                card.className = 'extension-card';
                const currentVotes = ext.rockets || 0; // ä½¿ç”¨å¾å¾Œç«¯è¼‰å…¥çš„çœŸå¯¦æŠ•ç¥¨æ•¸
                card.innerHTML = `
                    <div class="extension-name">${ext.name}</div>
                    <div class="vote-input">
                        <input type="number" id="votes-${ext.id}" min="0" value="${currentVotes}" class="vote-count">
                        <div class="control-buttons">
                            <button class="set-votes" onclick="setVotes('${ext.id}')">è¨­å®šç¥¨æ•¸</button>
                            <button onclick="addVotes('${ext.id}', 1)">+1</button>
                            <button onclick="addVotes('${ext.id}', 10)">+10</button>
                            <button onclick="addVotes('${ext.id}', 100)">+100</button>
                        </div>
                    </div>
                `;
                voteControls.appendChild(card);
            });
        }
        
        // åˆå§‹åŒ– WebSocket é€£æ¥
        function initWebSocket() {
            try {
                clearTimeout(reconnectTimeout);
                
                updateStatus('connecting', 'æ­£åœ¨é€£æ¥...');
                
                socket = new WebSocket(wsUrl);
                
                socket.onopen = function() {
                    console.log("WebSocket é€£ç·šå»ºç«‹");
                    updateStatus('connected', 'å·²é€£æ¥');
                    addLog('success', 'WebSocket é€£ç·šå·²å»ºç«‹');
                    
                    // é€£æ¥æˆåŠŸå¾Œç«‹å³è«‹æ±‚çµ±è¨ˆæ•¸æ“šå’Œä¿®æ”¹è¨˜éŒ„
                    setTimeout(() => {
                        requestStatistics(true);  // åŒ…å«ä¿®æ”¹è¨˜éŒ„
                        // å•Ÿå‹•è‡ªå‹•åˆ·æ–°çµ±è¨ˆæ•¸æ“š
                        startAutoRefreshStats();
                    }, 500);
                };                socket.onmessage = function(event) {
                    console.log('æ”¶åˆ°WebSocketæ¶ˆæ¯åŸå§‹æ•¸æ“š:', event.data);
                    
                    try {
                        const data = JSON.parse(event.data);
                        console.log('è§£æå¾Œçš„WebSocketæ¶ˆæ¯:', data);
                        addLog('info', `æ”¶åˆ°æ¶ˆæ¯: ${JSON.stringify(data)}`);
                        
                        // è™•ç†çµ±è¨ˆæ•¸æ“šæ›´æ–°
                        if (data.type && data.type.toLowerCase() === 'stats_update') {
                            console.log('æ”¶åˆ°çµ±è¨ˆæ•¸æ“šæ›´æ–°');
                            if (data.statistics) {
                                console.log('çµ±è¨ˆæ•¸æ“šå…§å®¹:', data.statistics);
                                addLog('success', `æ”¶åˆ°çµ±è¨ˆæ•¸æ“š: ${JSON.stringify(data.statistics)}`);
                                updateStatistics(data.statistics);
                            } else {
                                console.error('æ”¶åˆ°çš„çµ±è¨ˆæ•¸æ“šç¼ºå°‘statisticså±¬æ€§');
                                addLog('error', 'æ”¶åˆ°ç„¡æ•ˆçš„çµ±è¨ˆæ•¸æ“šæ ¼å¼');
                            }
                            
                            // è™•ç†ä¿®æ”¹è¨˜éŒ„ï¼ˆå¦‚æœåŒ…å«ï¼‰
                            if (data.modificationHistory) {
                                console.log('æ”¶åˆ°ä¿®æ”¹è¨˜éŒ„:', data.modificationHistory.length, 'ç­†');
                                // è¼‰å…¥æ‰€æœ‰ä¿®æ”¹è¨˜éŒ„ï¼ŒåŒ…æ‹¬åˆ·æ–°æ“ä½œ
                                loadModificationHistory(data.modificationHistory);
                                addLog('success', `è¼‰å…¥ä¿®æ”¹è¨˜éŒ„: ${data.modificationHistory.length} ç­†è¨˜éŒ„`);
                            }
                        }
                        
                        // è™•ç†é€£æ¥æ•¸æ›´æ–°
                        if (data.type && data.type.toLowerCase() === 'connection_count') {
                            addLog('info', `æ”¶åˆ°é€£æ¥æ•¸æ›´æ–°: æ´»èºäººæ•¸ ${data.activeParticipants}, ç¸½åƒèˆ‡äººæ•¸ ${data.totalParticipants}`);
                            if (data.activeParticipants !== undefined) {
                                statistics.activeParticipants = data.activeParticipants;
                            }
                            if (data.totalParticipants !== undefined) {
                                statistics.totalParticipants = data.totalParticipants;
                            }
                            updateStatisticsDisplay();
                        }
                        
                        // è™•ç†ç«ç®­ç™¼å°„äº‹ä»¶
                        if (data.type && data.type.toLowerCase() === 'rocket_launched') {
                            addLog('success', `æ”¶åˆ°ç«ç®­ç™¼å°„äº‹ä»¶`);
                            // è¨˜éŒ„ç«ç®­ç™¼å°„äº‹ä»¶ï¼Œä½†ä¸æ‰‹å‹•å¢åŠ çµ±è¨ˆæ•¸æ“š
                            // æ•¸æ“šæ›´æ–°æœƒé€šéå¾ŒçºŒçš„ stats_update äº‹ä»¶ä¾†è™•ç†
                            addModificationRecord('ç”¨æˆ¶ç™¼å°„ç«ç®­', 'æ”¶åˆ°ç«ç®­ç™¼å°„é€šçŸ¥ï¼Œç­‰å¾…çµ±è¨ˆæ•¸æ“šæ›´æ–°');
                        }
                        
                        // è™•ç†ç®¡ç†å“¡ä¿®æ”¹çµ±è¨ˆæ•¸æ“šæˆåŠŸå›æ‡‰
                        if (data.type && data.type.toLowerCase() === 'admin_modify_stats_success') {
                            addLog('success', `çµ±è¨ˆæ•¸æ“šä¿®æ”¹æˆåŠŸ: ${data.message}`);
                            
                            // å¦‚æœæœ‰ç­‰å¾…ç¢ºèªçš„ä¿®æ”¹ï¼Œæ‡‰ç”¨å®ƒ
                            if (pendingStatsModification) {
                                statistics.totalRockets = pendingStatsModification.totalRockets;
                                statistics.totalParticipants = pendingStatsModification.totalParticipants;
                                updateStatisticsDisplay();
                                
                                addLog('success', `å‰ç«¯æ•¸æ“šå·²æ›´æ–°: ç«ç®­${statistics.totalRockets}, åƒèˆ‡${statistics.totalParticipants}`);
                                pendingStatsModification = null; // æ¸…é™¤å¾…ç¢ºèªç‹€æ…‹
                            }
                            
                            // å¦‚æœå¾Œç«¯ä¹Ÿè¿”å›äº†çµ±è¨ˆæ•¸æ“šï¼Œä½¿ç”¨å¾Œç«¯æ•¸æ“šç‚ºæº–
                            if (data.statistics) {
                                updateStatistics(data.statistics);
                            }
                        }
                        
                        // è™•ç†ç®¡ç†å“¡ä¿®æ”¹çµ±è¨ˆæ•¸æ“šå¤±æ•—å›æ‡‰
                        if (data.type && data.type.toLowerCase() === 'admin_modify_stats_error') {
                            addLog('error', `çµ±è¨ˆæ•¸æ“šä¿®æ”¹å¤±æ•—: ${data.message || 'æœªçŸ¥éŒ¯èª¤'}`);
                            
                            // æ¸…é™¤å¾…ç¢ºèªç‹€æ…‹
                            if (pendingStatsModification) {
                                addLog('error', 'ä¿®æ”¹è«‹æ±‚å¤±æ•—ï¼Œå‰ç«¯æ•¸æ“šæœªæ›´æ–°');
                                pendingStatsModification = null;
                            }
                            
                            // æ¸…é™¤ç®¡ç†å“¡ä¿è­·æ¨™è¨˜
                            adminModificationProtection.totalRockets = false;
                            adminModificationProtection.totalParticipants = false;
                            // é‡ç½®åŸºæº–å€¼
                            adminModificationProtection.baselineValues.totalRockets = 0;
                            adminModificationProtection.baselineValues.totalParticipants = 0;
                            if (adminModificationProtection.protectionTimeout) {
                                clearTimeout(adminModificationProtection.protectionTimeout);
                            }
                        }
                        
                        // è™•ç†ç®¡ç†å“¡é‡ç½®æ´»èºåƒèˆ‡äººæ•¸æˆåŠŸå›æ‡‰
                        if (data.type && data.type.toLowerCase() === 'admin_reset_active_participants_success') {
                            addLog('success', `é‡ç½®æˆåŠŸ: ${data.message}`);
                            if (data.statistics) {
                                // è¨˜éŒ„é‡ç½®æ“ä½œ
                                const oldActiveParticipants = statistics.activeParticipants;
                                const newActiveParticipants = data.statistics.activeParticipants;
                                if (oldActiveParticipants !== newActiveParticipants) {
                                    addModificationRecord('é‡ç½®æ´»èºåƒèˆ‡äººæ•¸', `å¾æ‰‹å‹•è¨­å®šçš„ ${oldActiveParticipants} é‡ç½®ç‚ºå¯¦éš›é€£æ¥æ•¸ ${newActiveParticipants}`);
                                }
                                updateStatistics(data.statistics);
                            }
                        }
                        
                        // è™•ç†ç®¡ç†å“¡é‡ç½®ä¿®æ”¹æ¨™è¨˜æˆåŠŸå›æ‡‰
                        if (data.type && data.type.toLowerCase() === 'admin_reset_modifications_success') {
                            addLog('success', `é‡ç½®æˆåŠŸ: ${data.message}`);
                            if (data.statistics) {
                                // è¨˜éŒ„é‡ç½®æ“ä½œ
                                addModificationRecord('æ¢å¾©è‡ªå‹•è¨ˆç®—', `ç®¡ç†å“¡æ‰‹å‹•ä¿®æ”¹æ¨™è¨˜å·²æ¸…é™¤ï¼Œç³»çµ±å·²é‡æ–°è¨ˆç®—çµ±è¨ˆæ•¸æ“š`);
                                updateStatistics(data.statistics);
                            }
                        }
                        
                        // è™•ç†ç®¡ç†å“¡é‡ç½®ä¿®æ”¹æ¨™è¨˜å¤±æ•—å›æ‡‰
                        if (data.type && data.type.toLowerCase() === 'admin_reset_modifications_error') {
                            addLog('error', `é‡ç½®å¤±æ•—: ${data.message || 'æœªçŸ¥éŒ¯èª¤'}`);
                        }
                        
                        // è™•ç†æ¸…é™¤ä¿®æ”¹è¨˜éŒ„æˆåŠŸå›æ‡‰
                        if (data.type && data.type.toLowerCase() === 'clear_modification_history_success') {
                            addLog('success', `æ¸…é™¤æˆåŠŸ: ${data.message}`);
                            // å‰ç«¯è¨˜éŒ„å·²åœ¨clearModificationHistory()ä¸­æ¸…é™¤ï¼Œä¸éœ€è¦é¡å¤–æ“ä½œ
                        }
                    } catch (error) {
                        console.error('è§£æWebSocketæ¶ˆæ¯å¤±æ•—:', error);
                        console.error('åŸå§‹æ¶ˆæ¯:', event.data);
                        addLog('error', `è§£ææ¶ˆæ¯å¤±æ•—: ${error.message}`);
                    }
                };
                
                socket.onclose = function(event) {
                    updateStatus('disconnected', 'å·²æ–·é–‹é€£æ¥');
                    addLog('error', `WebSocket é€£æ¥é—œé–‰: ${event.code}`);
                    
                    // æ¸…é™¤çµ±è¨ˆæ•¸æ“šè‡ªå‹•åˆ·æ–° interval
                    if (statsRefreshInterval) {
                        clearInterval(statsRefreshInterval);
                        statsRefreshInterval = null;
                    }
                    
                    // é‡æ–°é€£æ¥
                    reconnectTimeout = setTimeout(() => {
                        addLog('info', 'å˜—è©¦é‡æ–°é€£æ¥...');
                        initWebSocket();
                    }, 3000);
                };
                
                socket.onerror = function(error) {
                    updateStatus('disconnected', 'é€£æ¥éŒ¯èª¤');
                    addLog('error', 'WebSocket éŒ¯èª¤');
                };
                
            } catch (error) {
                updateStatus('disconnected', 'é€£æ¥å¤±æ•—');
                addLog('error', `WebSocket åˆå§‹åŒ–å¤±æ•—: ${error.message}`);
                
                // é‡æ–°é€£æ¥
                reconnectTimeout = setTimeout(() => {
                    addLog('info', 'å˜—è©¦é‡æ–°é€£æ¥...');
                    initWebSocket();
                }, 5000);
            }
        }
        
        // æ›´æ–°é€£æ¥ç‹€æ…‹
        function updateStatus(status, message) {
            const wsStatus = document.getElementById('wsStatus');
            const indicator = wsStatus.querySelector('.status-indicator');
            
            // ç§»é™¤æ‰€æœ‰ç‹€æ…‹é¡
            indicator.classList.remove('disconnected', 'connecting', 'connected');
            
            // æ·»åŠ ç•¶å‰ç‹€æ…‹é¡
            indicator.classList.add(status);
            
            // æ›´æ–°æ–‡å­—
            wsStatus.querySelector('span').textContent = message;
        }
        
        // è¨­å®šç¥¨æ•¸
        function setVotes(extensionId) {
            const votesInput = document.getElementById(`votes-${extensionId}`);
            const votesCount = parseInt(votesInput.value) || 0;
            const extensionName = getExtensionNameById(extensionId);
            
            if (socket && socket.readyState === WebSocket.OPEN) {
                const message = {
                    type: 'admin_set_votes',
                    extensionId: extensionId,
                    votes: votesCount,
                    timestamp: new Date().toISOString()
                };
                
                socket.send(JSON.stringify(message));
                addLog('info', `è¨­å®š ${extensionName} çš„ç¥¨æ•¸ç‚º ${votesCount}`);
                
                // è¨˜éŒ„æŠ•ç¥¨æ§åˆ¶æ“ä½œ
                addModificationRecord('è¨­å®šæ“´å……å¥—ä»¶ç¥¨æ•¸', `${extensionName}: è¨­å®šç‚º ${votesCount} ç¥¨`);
            } else {
                addLog('error', 'WebSocket æœªé€£æ¥ï¼Œç„¡æ³•è¨­å®šç¥¨æ•¸');
            }
        }
        
        // å¢åŠ ç¥¨æ•¸
        function addVotes(extensionId, amount) {
            const votesInput = document.getElementById(`votes-${extensionId}`);
            const currentVotes = parseInt(votesInput.value) || 0;
            const newVotes = currentVotes + amount;
            const extensionName = getExtensionNameById(extensionId);
            
            // æ›´æ–°è¼¸å…¥æ¡†çš„å€¼
            votesInput.value = newVotes;
            
            if (socket && socket.readyState === WebSocket.OPEN) {
                const message = {
                    type: 'admin_set_votes',
                    extensionId: extensionId,
                    votes: newVotes,
                    timestamp: new Date().toISOString()
                };
                
                socket.send(JSON.stringify(message));
                addLog('info', `å¢åŠ  ${extensionName} çš„ç¥¨æ•¸ ${amount}ï¼Œç¸½æ•¸: ${newVotes}`);
                
                // è¨˜éŒ„æŠ•ç¥¨æ§åˆ¶æ“ä½œ
                addModificationRecord('å¢åŠ æ“´å……å¥—ä»¶ç¥¨æ•¸', `${extensionName}: ${currentVotes} â†’ ${newVotes} (+${amount})`);
            } else {
                addLog('error', 'WebSocket æœªé€£æ¥ï¼Œç„¡æ³•å¢åŠ ç¥¨æ•¸');
            }
        }
        
        // æ›´æ–°çµ±è¨ˆæ•¸æ“š
        function updateStatistics(stats) {
            if (stats) {
                // è™•ç†ç«ç®­ç¸½æ•¸æ›´æ–° - æ”¯æ´å¢é‡æ›´æ–°å³ä½¿åœ¨ä¿è­·æœŸé–“
                if (stats.totalRockets !== undefined) {
                    const oldRockets = statistics.totalRockets;
                    
                    if (!adminModificationProtection.totalRockets) {
                        // æ²’æœ‰ä¿è­·æ¨™è¨˜æ™‚ï¼Œç›´æ¥ä½¿ç”¨å¾Œç«¯æ•¸æ“š
                        statistics.totalRockets = stats.totalRockets;
                        
                        // å¦‚æœç«ç®­æ•¸é‡å¢åŠ ï¼Œè¨˜éŒ„åˆ°ä¿®æ”¹è¨˜éŒ„ä¸­
                        if (stats.totalRockets > oldRockets) {
                            addModificationRecord('ç”¨æˆ¶ç™¼å°„ç«ç®­', `ç«ç®­ç¸½æ•¸å¾ ${oldRockets} å¢åŠ åˆ° ${stats.totalRockets}`);
                        }
                    } else {
                        // æœ‰ä¿è­·æ¨™è¨˜æ™‚ï¼Œåªè™•ç†ç›¸å°æ–¼åŸºæº–å€¼çš„æ–°å¢é‡
                        const baselineRockets = adminModificationProtection.baselineValues.totalRockets;
                        const backendIncrease = Math.max(0, stats.totalRockets - baselineRockets);
                        const alreadyAppliedIncrease = Math.max(0, oldRockets - baselineRockets);
                        const newIncrement = backendIncrease - alreadyAppliedIncrease;
                        
                        if (newIncrement > 0) {
                            statistics.totalRockets += newIncrement;
                            console.log(`ğŸ”’ ä¿è­·æœŸé–“ç«ç®­å¢é‡æ›´æ–°: +${newIncrement} (åŸºæº–: ${baselineRockets}, å¾Œç«¯: ${stats.totalRockets}, å‰ç«¯: ${oldRockets} â†’ ${statistics.totalRockets})`);
                            addModificationRecord('ä¿è­·æœŸé–“ç«ç®­å¢é‡', `æ–°ç«ç®­ç™¼å°„ ${newIncrement} å€‹ (ç¸½æ•¸: ${statistics.totalRockets})`);
                        } else {
                            console.log('ğŸ”’ ä¿è­·æœŸé–“ç„¡æ–°ç«ç®­å¢é‡');
                        }
                    }
                }
                
                // è™•ç†åƒèˆ‡äººæ•¸æ›´æ–° - æ”¯æ´å¢é‡æ›´æ–°å³ä½¿åœ¨ä¿è­·æœŸé–“  
                if (stats.totalParticipants !== undefined) {
                    const oldParticipants = statistics.totalParticipants;
                    
                    if (!adminModificationProtection.totalParticipants) {
                        // æ²’æœ‰ä¿è­·æ¨™è¨˜æ™‚ï¼Œç›´æ¥ä½¿ç”¨å¾Œç«¯æ•¸æ“š
                        statistics.totalParticipants = stats.totalParticipants;
                    } else {
                        // æœ‰ä¿è­·æ¨™è¨˜æ™‚ï¼Œåªè™•ç†ç›¸å°æ–¼åŸºæº–å€¼çš„æ–°å¢é‡
                        const baselineParticipants = adminModificationProtection.baselineValues.totalParticipants;
                        const backendIncrease = Math.max(0, stats.totalParticipants - baselineParticipants);
                        const alreadyAppliedIncrease = Math.max(0, oldParticipants - baselineParticipants);
                        const newIncrement = backendIncrease - alreadyAppliedIncrease;
                        
                        if (newIncrement > 0) {
                            statistics.totalParticipants += newIncrement;
                            console.log(`ğŸ”’ ä¿è­·æœŸé–“åƒèˆ‡äººæ•¸å¢é‡æ›´æ–°: +${newIncrement} (åŸºæº–: ${baselineParticipants}, å¾Œç«¯: ${stats.totalParticipants}, å‰ç«¯: ${oldParticipants} â†’ ${statistics.totalParticipants})`);
                            addModificationRecord('ä¿è­·æœŸé–“åƒèˆ‡äººæ•¸å¢é‡', `æ–°åƒèˆ‡ç”¨æˆ¶ ${newIncrement} å€‹ (ç¸½æ•¸: ${statistics.totalParticipants})`);
                        } else {
                            console.log('ğŸ”’ ä¿è­·æœŸé–“ç„¡æ–°åƒèˆ‡äººæ•¸å¢é‡');
                        }
                    }
                }
                
                if (stats.activeParticipants !== undefined) {
                    const oldActiveParticipants = statistics.activeParticipants;
                    statistics.activeParticipants = stats.activeParticipants;
                    
                    // æª¢æŸ¥æ˜¯å¦å‰µæ–°é«˜
                    if (stats.activeParticipants > statistics.maxActiveParticipants) {
                        statistics.maxActiveParticipants = stats.activeParticipants;
                        statistics.maxActiveTime = new Date().toISOString();
                        
                        // è¨˜éŒ„æ–°çš„æœ€é«˜åœ¨ç·šäººæ•¸
                        addModificationRecord('å‰µæ–°é«˜åœ¨ç·šäººæ•¸', `åœ¨ç·šäººæ•¸é”åˆ°æ–°é«˜: ${statistics.maxActiveParticipants} äºº`);
                    }
                }
                if (stats.maxActiveParticipants !== undefined) {
                    statistics.maxActiveParticipants = stats.maxActiveParticipants;
                }
                if (stats.maxActiveTime !== undefined) {
                    statistics.maxActiveTime = stats.maxActiveTime;
                }
                updateStatisticsDisplay();
            }
        }
        
        // æ›´æ–°çµ±è¨ˆæ•¸æ“šé¡¯ç¤º
        function updateStatisticsDisplay() {
            document.getElementById('totalRockets').textContent = statistics.totalRockets;
            document.getElementById('totalParticipants').textContent = statistics.totalParticipants || 0;
            document.getElementById('activeParticipants').textContent = statistics.activeParticipants || 0;
            document.getElementById('maxActiveParticipants').textContent = statistics.maxActiveParticipants || 0;
            
            // é¡¯ç¤ºæœ€é«˜åœ¨ç·šæ™‚é–“
            const maxTimeElement = document.getElementById('maxActiveTime');
            if (statistics.maxActiveTime) {
                maxTimeElement.textContent = formatTimeGMT8(statistics.maxActiveTime);
            } else {
                maxTimeElement.textContent = '--';
            }
        }
        
        // é¡¯ç¤ºä¿®æ”¹çµ±è¨ˆæ•¸æ“šå½ˆçª—
        function showModifyStatsModal() {
            const modal = document.getElementById('modifyStatsModal');
            
            // ç”¨ç•¶å‰æ•¸æ“šå¡«å……è¼¸å…¥æ¡†
            document.getElementById('modifyTotalRockets').value = statistics.totalRockets;
            document.getElementById('modifyActiveParticipants').value = statistics.activeParticipants; // é¡¯ç¤ºä½†ä¸å¯ä¿®æ”¹
            document.getElementById('modifyTotalParticipants').value = statistics.totalParticipants;
            
            modal.style.display = 'flex';
            addLog('info', 'æ‰“é–‹ä¿®æ”¹çµ±è¨ˆæ•¸æ“šå½ˆçª—');
        }
        
        // é—œé–‰ä¿®æ”¹çµ±è¨ˆæ•¸æ“šå½ˆçª—
        function closeModifyStatsModal() {
            const modal = document.getElementById('modifyStatsModal');
            modal.style.display = 'none';
            addLog('info', 'é—œé–‰ä¿®æ”¹çµ±è¨ˆæ•¸æ“šå½ˆçª—');
        }
        
        // é‡ç½®æ´»èºåƒèˆ‡äººæ•¸ç‚ºå¯¦éš›é€£æ¥æ•¸
        function resetActiveParticipants() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                const message = {
                    type: 'admin_reset_active_participants',
                    timestamp: new Date().toISOString()
                };
                
                socket.send(JSON.stringify(message));
                addLog('info', 'å·²è«‹æ±‚é‡ç½®æ´»èºåƒèˆ‡äººæ•¸ç‚ºå¯¦éš›é€£æ¥æ•¸');
            } else {
                addLog('error', 'WebSocket æœªé€£æ¥ï¼Œç„¡æ³•é‡ç½®æ´»èºåƒèˆ‡äººæ•¸');
            }
        }
        
        // é‡ç½®ç®¡ç†å“¡ä¿®æ”¹æ¨™è¨˜ï¼Œæ¢å¾©è‡ªå‹•è¨ˆç®—
        function resetAdminModifications() {
            if (confirm('ç¢ºå®šè¦æ¢å¾©è‡ªå‹•è¨ˆç®—å—ï¼Ÿé€™å°‡æ¸…é™¤æ‰€æœ‰æ‰‹å‹•ä¿®æ”¹çš„ä¿è­·æ¨™è¨˜ï¼Œç³»çµ±æœƒæ ¹æ“šå¯¦éš›ç«ç®­æŠ•ç¥¨æ•¸å’Œåƒèˆ‡äººæ•¸è‡ªå‹•è¨ˆç®—çµ±è¨ˆæ•¸æ“šã€‚')) {
                if (socket && socket.readyState === WebSocket.OPEN) {
                    const message = {
                        type: 'admin_reset_modifications',
                        timestamp: new Date().toISOString()
                    };
                    
                    socket.send(JSON.stringify(message));
                    addLog('info', 'å·²è«‹æ±‚æ¢å¾©è‡ªå‹•è¨ˆç®—æ¨¡å¼');
                    
                    // æ¸…é™¤å‰ç«¯çš„ç®¡ç†å“¡ä¿è­·æ¨™è¨˜
                    adminModificationProtection.totalRockets = false;
                    adminModificationProtection.totalParticipants = false;
                    // é‡ç½®åŸºæº–å€¼
                    adminModificationProtection.baselineValues.totalRockets = 0;
                    adminModificationProtection.baselineValues.totalParticipants = 0;
                    if (adminModificationProtection.protectionTimeout) {
                        clearTimeout(adminModificationProtection.protectionTimeout);
                    }
                    
                    addLog('success', 'å‰ç«¯ä¿è­·æ¨™è¨˜å·²æ¸…é™¤');
                } else {
                    addLog('error', 'WebSocket æœªé€£æ¥ï¼Œç„¡æ³•æ¢å¾©è‡ªå‹•è¨ˆç®—');
                }
                
                closeModifyStatsModal();
            }
        }
        
                // ç¢ºèªä¿®æ”¹çµ±è¨ˆæ•¸æ“š
        function confirmModifyStats() {
            const newTotalRockets = parseInt(document.getElementById('modifyTotalRockets').value) || 0;
            const newTotalParticipants = parseInt(document.getElementById('modifyTotalParticipants').value) || 0;
            
            // è¨˜éŒ„ä¿®æ”¹å‰çš„æ•¸å€¼ï¼ˆä¸åŒ…å«activeParticipantsï¼Œå› ç‚ºä¸å¯ä¿®æ”¹ï¼‰
            const oldValues = {
                totalRockets: statistics.totalRockets,
                totalParticipants: statistics.totalParticipants
            };
            
            if (socket && socket.readyState === WebSocket.OPEN) {
                const message = {
                    type: 'admin_modify_stats',
                    statistics: {
                        totalRockets: newTotalRockets,
                        totalParticipants: newTotalParticipants
                        // activeParticipants ä¸å†åŒ…å«åœ¨ä¿®æ”¹è«‹æ±‚ä¸­
                    },
                    timestamp: new Date().toISOString()
                };
                
                // è¨­ç½®ä¿è­·æ¨™è¨˜ï¼Œé˜²æ­¢å³æ™‚è¢«è¦†è“‹
                if (oldValues.totalRockets !== newTotalRockets) {
                    adminModificationProtection.totalRockets = true;
                    // è¨˜éŒ„æ‰‹å‹•ä¿®æ”¹æ™‚çš„å¾Œç«¯åŸºæº–å€¼ï¼Œç”¨æ–¼å¾ŒçºŒå¢é‡è¨ˆç®—
                    adminModificationProtection.baselineValues.totalRockets = oldValues.totalRockets;
                    console.log('ğŸ”’ å·²è¨­ç½®ç«ç®­ç¸½æ•¸ä¿è­·æ¨™è¨˜ï¼ŒåŸºæº–å€¼:', oldValues.totalRockets);
                }
                if (oldValues.totalParticipants !== newTotalParticipants) {
                    adminModificationProtection.totalParticipants = true;
                    // è¨˜éŒ„æ‰‹å‹•ä¿®æ”¹æ™‚çš„å¾Œç«¯åŸºæº–å€¼ï¼Œç”¨æ–¼å¾ŒçºŒå¢é‡è¨ˆç®—
                    adminModificationProtection.baselineValues.totalParticipants = oldValues.totalParticipants;
                    console.log('ğŸ”’ å·²è¨­ç½®åƒèˆ‡äººæ•¸ä¿è­·æ¨™è¨˜ï¼ŒåŸºæº–å€¼:', oldValues.totalParticipants);
                }
                
                // æ¸…é™¤ä¹‹å‰çš„ä¿è­·è¶…æ™‚
                if (adminModificationProtection.protectionTimeout) {
                    clearTimeout(adminModificationProtection.protectionTimeout);
                }
                
                // è¨­ç½®ä¿è­·è¶…æ™‚ (10ç§’å¾Œè‡ªå‹•æ¸…é™¤ä¿è­·)
                adminModificationProtection.protectionTimeout = setTimeout(() => {
                    adminModificationProtection.totalRockets = false;
                    adminModificationProtection.totalParticipants = false;
                    // é‡ç½®åŸºæº–å€¼
                    adminModificationProtection.baselineValues.totalRockets = 0;
                    adminModificationProtection.baselineValues.totalParticipants = 0;
                    console.log('ğŸ”“ ç®¡ç†å“¡ä¿®æ”¹ä¿è­·å·²åˆ°æœŸï¼Œæ¢å¾©è‡ªå‹•æ›´æ–°');
                    addLog('info', 'ç®¡ç†å“¡ä¿®æ”¹ä¿è­·å·²è§£é™¤');
                }, 10000);
                
                socket.send(JSON.stringify(message));
                addLog('success', `ä¿®æ”¹çµ±è¨ˆæ•¸æ“š: ç«ç®­${newTotalRockets}, ç¸½åƒèˆ‡${newTotalParticipants} (ä¿è­·10ç§’)`);
                
                // å»ºç«‹ä¿®æ”¹è©³æƒ…è¨˜éŒ„ï¼ˆä¸åŒ…å«activeParticipantsï¼‰
                const changes = [];
                if (oldValues.totalRockets !== newTotalRockets) {
                    changes.push(`ç¸½ç«ç®­æ•¸: ${oldValues.totalRockets} â†’ ${newTotalRockets}`);
                }
                if (oldValues.totalParticipants !== newTotalParticipants) {
                    changes.push(`æ­·å²ç¸½åƒèˆ‡: ${oldValues.totalParticipants} â†’ ${newTotalParticipants}`);
                }
                
                if (changes.length > 0) {
                    addModificationRecord('æ‰‹å‹•ä¿®æ”¹çµ±è¨ˆæ•¸æ“š', changes.join(', '));
                }
                
                // ä¸ç«‹å³æ›´æ–°æœ¬åœ°çµ±è¨ˆæ•¸æ“šï¼Œç­‰å¾…å¾Œç«¯ç¢ºèªæˆåŠŸ
                // è¨­ç½®ç­‰å¾…ç¢ºèªçš„ç‹€æ…‹
                pendingStatsModification = {
                    totalRockets: newTotalRockets,
                    totalParticipants: newTotalParticipants,
                    timestamp: new Date().toISOString()
                };
                
                addLog('info', 'æ­£åœ¨ç­‰å¾…å¾Œç«¯ç¢ºèªä¿®æ”¹...');
                
                // è¨­ç½®è¶…æ™‚ï¼Œå¦‚æœ5ç§’å…§æ²’æ”¶åˆ°ç¢ºèªï¼Œèªç‚ºå¤±æ•—
                setTimeout(() => {
                    if (pendingStatsModification) {
                        addLog('error', 'ä¿®æ”¹è«‹æ±‚è¶…æ™‚ï¼Œå¾Œç«¯å¯èƒ½æ²’æœ‰å›æ‡‰');
                        pendingStatsModification = null;
                        
                        // æ¸…é™¤ç®¡ç†å“¡ä¿è­·æ¨™è¨˜
                        adminModificationProtection.totalRockets = false;
                        adminModificationProtection.totalParticipants = false;
                        // é‡ç½®åŸºæº–å€¼
                        adminModificationProtection.baselineValues.totalRockets = 0;
                        adminModificationProtection.baselineValues.totalParticipants = 0;
                        if (adminModificationProtection.protectionTimeout) {
                            clearTimeout(adminModificationProtection.protectionTimeout);
                        }
                    }
                }, 5000);
                
            } else {
                addLog('error', 'WebSocket æœªé€£æ¥ï¼Œç„¡æ³•ä¿®æ”¹çµ±è¨ˆæ•¸æ“š');
            }
            
            closeModifyStatsModal();
        }
        
        // æ·»åŠ æ—¥èªŒ
        function addLog(type, message) {
            const logOutput = document.getElementById('logOutput');
            const now = new Date();
            const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="log-time">[${timeString}]</span>
                <span class="log-type ${type}">[${type.toUpperCase()}]</span>
                <span class="log-content">${message}</span>
            `;
            
            logOutput.appendChild(logEntry);
            logOutput.scrollTop = logOutput.scrollHeight;
        }
        
        // æ ¹æ“š extensionId ç²å–æ“´å……å¥—ä»¶åç¨±
        function getExtensionNameById(extensionId) {
            const extension = extensions.find(ext => ext.id === extensionId);
            return extension ? extension.name : extensionId;
        }
        
        // è«‹æ±‚çµ±è¨ˆæ•¸æ“š
        function requestStatistics(includeHistory = false) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                const message = {
                    type: 'request_stats',  // ç¢ºä¿ä½¿ç”¨èˆ‡æœå‹™å™¨åŒ¹é…çš„å°å¯«åç¨±
                    timestamp: new Date().toISOString(),
                    includeHistory: includeHistory  // æ˜¯å¦è«‹æ±‚ä¿®æ”¹è¨˜éŒ„
                };
                
                const messageStr = JSON.stringify(message);
                console.log('æ­£åœ¨ç™¼é€WebSocketæ¶ˆæ¯:', messageStr);
                socket.send(messageStr);
                if (includeHistory) {
                    addLog('info', 'å·²è«‹æ±‚çµ±è¨ˆæ•¸æ“šå’Œä¿®æ”¹è¨˜éŒ„');
                } else {
                    addLog('info', `å·²è«‹æ±‚æœ€æ–°çµ±è¨ˆæ•¸æ“š: ${messageStr}`);
                }
            } else {
                addLog('error', 'WebSocket æœªé€£æ¥ï¼Œç„¡æ³•è«‹æ±‚çµ±è¨ˆæ•¸æ“š');
            }
        }
        
        // åŒæ­¥çµ±è¨ˆæ•¸æ“š
        function syncStatistics() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                const message = {
                    type: 'sync_stats',
                    timestamp: new Date().toISOString()
                };
                
                socket.send(JSON.stringify(message));
                addLog('info', 'å·²è«‹æ±‚åŒæ­¥çµ±è¨ˆæ•¸æ“š');
                addModificationRecord('åŒæ­¥çµ±è¨ˆæ•¸æ“š', 'æ‰‹å‹•è§¸ç™¼æ•¸æ“šåŒæ­¥æ“ä½œ');
            } else {
                addLog('error', 'WebSocket æœªé€£æ¥ï¼Œç„¡æ³•åŒæ­¥çµ±è¨ˆæ•¸æ“š');
            }
        }
        
        // åˆå§‹åŒ–çµ±è¨ˆæ•¸æ“š
        function initializeStats() {
            // åˆå§‹å€¼ç‚º0ï¼Œé€£æ¥å¾Œå°‡è‡ªå‹•å¾æœå‹™å™¨ç²å–æœ€æ–°æ•¸æ“š
            updateStatisticsDisplay();
        }
        
        // è¨­å®šè‡ªå‹•åˆ·æ–°çµ±è¨ˆæ•¸æ“šï¼ˆæ¯15ç§’ï¼‰
        let statsRefreshInterval;
        
        function startAutoRefreshStats() {
            // å…ˆæ¸…é™¤å·²æœ‰çš„ interval (å¦‚æœå­˜åœ¨)
            if (statsRefreshInterval) {
                clearInterval(statsRefreshInterval);
            }
            
            // å»ºç«‹æ–°çš„åˆ·æ–° interval
            statsRefreshInterval = setInterval(() => {
                if (socket && socket.readyState === WebSocket.OPEN) {
                    requestStatistics(true); // åŒ…å«ä¿®æ”¹è¨˜éŒ„
                }
            }, 15000); // æ¯15ç§’åˆ·æ–°ä¸€æ¬¡
            
            addLog('info', 'è‡ªå‹•åˆ·æ–°çµ±è¨ˆæ•¸æ“šå·²å•Ÿå‹•ï¼ˆåŒ…å«ä¿®æ”¹è¨˜éŒ„ï¼‰');
        }
        
        // é é¢åŠ è¼‰æ™‚åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            initPage();
            initializeStats();
            
            // æ·»åŠ å½ˆçª—å¤–éƒ¨é»æ“Šé—œé–‰äº‹ä»¶
            const modifyStatsModal = document.getElementById('modifyStatsModal');
            if (modifyStatsModal) {
                modifyStatsModal.addEventListener('click', (e) => {
                    if (e.target === modifyStatsModal) {
                        closeModifyStatsModal();
                    }
                });
            }
            
            // åˆå§‹åŒ–æ¸¬é©—çµæœæ•¸æ“š
            refreshQuizResults();
            
            // ç¢ºä¿WebSocketé€£æ¥å»ºç«‹å¾ŒåŠ è¼‰çµ±è¨ˆæ•¸æ“š
            setTimeout(() => {
                if (socket && socket.readyState === WebSocket.OPEN) {
                    requestStatistics();
                }
            }, 1000);
        });
        
        // æ¸¬é©—çµæœç›¸é—œå‡½æ•¸
        async function refreshQuizResults() {
            try {
                // ä½¿ç”¨é…ç½®ä¸­çš„ API URL æˆ–ç›¸å°è·¯å¾‘
                const apiUrl = window.CONFIG?.API_BASE_URL ? 
                    `${window.CONFIG.API_BASE_URL}/quiz/results` : 
                    '/api/quiz/results';
                    
                const response = await fetch(apiUrl);
                if (response.ok) {
                    const data = await response.json();
                    const count = data.data.count || 0;
                    document.getElementById('quizResultsCount').textContent = count;
                    addLog('info', `å·²åˆ·æ–°æ¸¬é©—çµæœæ•¸æ“šï¼š${count} ç­†è¨˜éŒ„`);
                } else {
                    console.error('Failed to fetch quiz results:', response.statusText);
                    document.getElementById('quizResultsCount').textContent = 'è¼‰å…¥å¤±æ•—';
                    addLog('error', 'è¼‰å…¥æ¸¬é©—çµæœæ•¸æ“šå¤±æ•—');
                }
            } catch (error) {
                console.error('Error fetching quiz results:', error);
                document.getElementById('quizResultsCount').textContent = 'è¼‰å…¥éŒ¯èª¤';
                addLog('error', 'è¼‰å…¥æ¸¬é©—çµæœæ™‚ç™¼ç”ŸéŒ¯èª¤');
            }
        }
        
        async function downloadQuizResultsCSV() {
            try {
                addLog('info', 'æ­£åœ¨æº–å‚™ä¸‹è¼‰æ¸¬é©—çµæœ CSV æª”æ¡ˆ...');
                
                // ä½¿ç”¨é…ç½®ä¸­çš„ API URL æˆ–ç›¸å°è·¯å¾‘
                const apiUrl = window.CONFIG?.API_BASE_URL ? 
                    `${window.CONFIG.API_BASE_URL}/quiz/export/csv` : 
                    '/api/quiz/export/csv';
                
                const response = await fetch(apiUrl);
                
                if (response.ok) {
                    // ç²å–æª”æ¡ˆåç¨±
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let filename = 'quiz-results.csv';
                    if (contentDisposition) {
                        const match = contentDisposition.match(/filename="(.+)"/);
                        if (match) {
                            filename = match[1];
                        }
                    }
                    
                    // ç²å–æª”æ¡ˆå…§å®¹
                    const blob = await response.blob();
                    
                    // å»ºç«‹ä¸‹è¼‰é€£çµ
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = filename;
                    
                    // è§¸ç™¼ä¸‹è¼‰
                    document.body.appendChild(a);
                    a.click();
                    
                    // æ¸…ç†
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    addLog('info', `CSV æª”æ¡ˆä¸‹è¼‰æˆåŠŸï¼š${filename}`);
                } else if (response.status === 404) {
                    addLog('warning', 'ç›®å‰æ²’æœ‰æ¸¬é©—çµæœå¯ä¾›ä¸‹è¼‰');
                } else {
                    const errorData = await response.json();
                    addLog('error', `ä¸‹è¼‰å¤±æ•—ï¼š${errorData.error || response.statusText}`);
                }
            } catch (error) {
                console.error('Error downloading CSV:', error);
                addLog('error', 'ä¸‹è¼‰ CSV æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤');
            }
        }
    </script>
</body>
</html>
                console.log('é é¢åŠ è¼‰å¾Œè‡ªå‹•è«‹æ±‚çµ±è¨ˆæ•¸æ“š');
            }, 1000);
        });
    </script>
</body>
</html>
